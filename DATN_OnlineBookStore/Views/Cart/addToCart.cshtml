@model List<Tuple<string, int?, double, double?, int>>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<main class="main-wrapper">

    <!-- Start Cart Area  -->
    <div class="axil-product-cart-area axil-section-gap">
        <div class="container">
            <div class="axil-product-cart-wrap">
                <div class="product-table-heading">
                    <h4 class="title">Your Cart</h4>
                    <a href="#" class="cart-clear">Clear Shoping Cart</a>
                </div>
                <div class="table-responsive">
                    <form id="cartForm" method="post" action="@Url.Action("checkoutCart", "Cart")">
                        <table class="table axil-product-table axil-cart-table mb--40">
                            <tr>
                                <th>Chọn</th>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Giá</th>
                                <th>Thành tiền</th>
                                <th>Thao tác</th>
                            </tr>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td><input type="checkbox" name="selectedItems" value="@item.Item5" data-price="@item.Item4" data-quantity="@item.Item2" data-name="@item.Item1" data-price-per-unit="@item.Item3" style="opacity: 1 !important; position: static !important;" onchange="calculateTotalPrice()"></td>
                                    <td>@item.Item1</td>
                                    <td class="product-quantity" data-title="Qty">
                                        <div class="pro-qty">
                                            <span class="dec qtybtn">-</span>
                                            <input type="number" class="quantity-input" value="@item.Item2" onchange="updateCartItem('@item.Item5', this.value)">
                                            <span class="inc qtybtn">+</span>
                                        </div>
                                    </td>
                                    <td>@item.Item3.ToString("C")</td>
                                    <td>@item.Item4</td>
                                    <td><button type="button" onclick="removeFromCart('@item.Item5')">Xóa</button></td>
                                </tr>
                            }
                            <tr>
                                <td colspan="4" style="text-align:right">Tổng tiền:</td>
                                <td id="totalPrice">0</td>
                                <td></td>
                            </tr>
                        </table>
                        <div class="product-cupon-btn">
                            <button type="submit" class="axil-btn btn-outline">Thanh toán</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
    <!-- End Cart Area  -->

</main>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Xử lý sự kiện nhấn nút giảm số lượng
        document.querySelectorAll('.dec.qtybtn').forEach(function (button) {
            button.addEventListener('click', function () {
                var input = this.parentNode.querySelector('.quantity-input');
                var currentValue = parseInt(input.value, 10);
                if (currentValue > 1) { // Giá trị tối thiểu là 1
                    input.value = currentValue - 1;
                    updateCartItem(input.getAttribute('data-id'), input.value);
                }
            });
        });

        // Xử lý sự kiện nhấn nút tăng số lượng
        document.querySelectorAll('.inc.qtybtn').forEach(function (button) {
            button.addEventListener('click', function () {
                var input = this.parentNode.querySelector('.quantity-input');
                var currentValue = parseInt(input.value, 10);
                input.value = currentValue + 1;
                updateCartItem(input.getAttribute('data-id'), input.value);
            });
        });
    });
    function calculateTotalPrice() {
        let totalPrice = 0;
        $('input[name="selectedItems"]:checked').each(function () {
            totalPrice += parseFloat($(this).data('price'));
        });
        $('#totalPrice').text(totalPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
    }

    function updateCartItem(cartItemId, quantity) {
        $.ajax({
            url: '@Url.Action("UpdateCartItem", "Cart")',
            type: 'POST',
            data: { cartItemId: cartItemId, newQuantity: quantity },
            success: function (response) {
                if (response.success) {
                    var row = $('input[value="' + cartItemId + '"]').closest('tr');
                    row.find('input').val(quantity); // Cập nhật số lượng trong ô input
                    var pricePerItem = parseFloat(row.find('td:eq(2)').text()); // Lấy giá mỗi sản phẩm
                    var totalPriceCell = row.find('td.total-price');
                    var totalPrice = (quantity * pricePerItem).toFixed(2);
                    totalPriceCell.text(totalPrice); // Cập nhật thành tiền

                    calculateTotalPrice(); // Tính lại tổng tiền của giỏ hàng
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert('Có lỗi xảy ra, vui lòng thử lại.');
            }
        });
    }

    function removeFromCart(cartItemId) {
        if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng không?')) {
            $.ajax({
                url: '@Url.Action("removeFromCart", "Cart")',
                type: 'POST',
                data: { cartItemId: cartItemId },
                success: function (response) {
                    location.reload();
                },
                error: function () {
                    alert('Có lỗi xảy ra, vui lòng thử lại.');
                }
            });
        }
    }

    $(document).ready(function () {
        calculateTotalPrice();
    });
</script>



